import React, { useState, useEffect, useCallback } from 'react';
import apiService from '@/services/api';
import { formatDate } from '@/utils/formatters';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import type { Vulnerability, VulnerabilityFilters } from '@/types/api';
import VulnerabilityDetailDialog from './components/VulnerabilityDetailDialog';
import { renderSeverityBadge } from './components/severityBadge';

interface VulnerabilityTableProps {
  filters: VulnerabilityFilters;
}

const VulnerabilityTable = ({ filters }: VulnerabilityTableProps) => {
  const [vulnerabilities, setVulnerabilities] = useState<Vulnerability[]>([]);
  const [loading, setLoading] = useState(true);
  const [pagination, setPagination] = useState({
    page: 1,
    perPage: 50,
    totalPages: 1,
    total: 0,
  });
  const [selectedVuln, setSelectedVuln] = useState<Vulnerability | null>(null);
  const [showDetailModal, setShowDetailModal] = useState(false);

  const loadVulnerabilities = useCallback(async () => {
    try {
      setLoading(true);
      const params: Record<string, string | number | string[] | undefined> = {
        page: pagination.page,
        per_page: pagination.perPage,
        ...filters,
      };

      // Remove empty filters and convert 'all' to empty string
      Object.keys(params).forEach((key) => {
        const value = params[key];
        if (value === 'all') {
          params[key] = '';
        }
        // Keep arrays (for multi-select like software_vendor) if they have items
        if (Array.isArray(value)) {
          if (value.length === 0) {
            delete params[key];
          }
        } else if (value === '' || value === null || value === undefined) {
          delete params[key];
        }
      });

      const data = await apiService.getVulnerabilities(params);
      setVulnerabilities(data.data || []);
      setPagination((prev) => ({
        ...prev,
        totalPages: data.total_pages || Math.ceil((data.total || 0) / prev.perPage),
        total: data.total || 0,
      }));
    } catch (error) {
      console.error('Failed to load vulnerabilities:', error);
    } finally {
      setLoading(false);
    }
  }, [filters, pagination.page, pagination.perPage]);

  useEffect(() => {
    void loadVulnerabilities();
  }, [loadVulnerabilities]);

  const handlePageChange = (newPage: number) => {
    setPagination((prev) => ({ ...prev, page: newPage }));
  };

  const handlePerPageChange = (value: string) => {
    const parsed = Number.parseInt(value, 10);
    setPagination((prev) => ({ ...prev, perPage: Number.isNaN(parsed) ? prev.perPage : parsed, page: 1 }));
  };

  const handleShowDetail = (vuln: Vulnerability) => {
    setSelectedVuln(vuln);
    setShowDetailModal(true);
  };

  const getSeverityBadge = (severity: string | undefined) => renderSeverityBadge(severity);

  const renderThreatIntelBadges = (vuln: Vulnerability) => {
    const badges: React.ReactNode[] = [];
    if (vuln.metasploit_detected) {
      badges.push(
        <span key="metasploit" className="px-2 py-1 text-xs rounded-full bg-red-500/10 text-red-500 border border-red-500/30">
          Metasploit
        </span>
      );
    }
    if (vuln.nuclei_detected) {
      badges.push(
        <span key="nuclei" className="px-2 py-1 text-xs rounded-full bg-purple-500/10 text-purple-500 border border-purple-500/30">
          Nuclei
        </span>
      );
    }
    if (vuln.recordfuture_detected) {
      badges.push(
        <span key="recordfuture" className="px-2 py-1 text-xs rounded-full bg-emerald-500/10 text-emerald-500 border border-emerald-500/30">
          RecordFuture
        </span>
      );
    }
    if (badges.length === 0) {
      return <span className="text-text-tertiary text-sm">-</span>;
    }
    return <div className="flex gap-2 flex-wrap">{badges}</div>;
  };

  return (
    <>
      <Card className="glass-panel">
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle className="text-lg">Vulnerability List</CardTitle>
            <Select value={pagination.perPage.toString()} onValueChange={handlePerPageChange}>
              <SelectTrigger className="w-[140px]">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="25">25 per page</SelectItem>
                <SelectItem value="50">50 per page</SelectItem>
                <SelectItem value="100">100 per page</SelectItem>
                <SelectItem value="200">200 per page</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </CardHeader>
        <CardContent>
          <div className="rounded-md border border-glass-border overflow-x-auto">
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>CVE ID</TableHead>
                  <TableHead>Severity</TableHead>
                  <TableHead>CVSS Score</TableHead>
                  <TableHead>EPSS Score</TableHead>
                  <TableHead>Threat Intel</TableHead>
                  <TableHead>Affected Devices</TableHead>
                  <TableHead>Last Seen</TableHead>
                  <TableHead>Action</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {loading ? (
                  <TableRow>
                    <TableCell colSpan={10} className="text-center text-text-secondary">
                      Loading...
                    </TableCell>
                  </TableRow>
                ) : vulnerabilities.length === 0 ? (
                  <TableRow>
                    <TableCell colSpan={10} className="text-center text-text-secondary">
                      No data found
                    </TableCell>
                  </TableRow>
                ) : (
                  vulnerabilities.map((vuln) => (
                    <TableRow key={vuln.cve_id}>
                      <TableCell className="font-semibold text-text-primary">{vuln.cve_id || '-'}</TableCell>
                      <TableCell>{getSeverityBadge(vuln.severity)}</TableCell>
                      <TableCell>{typeof vuln.cvss_score === 'number' ? vuln.cvss_score.toFixed(1) : '-'}</TableCell>
                      <TableCell>{typeof vuln.cve_epss === 'number' ? vuln.cve_epss.toFixed(3) : '-'}</TableCell>
                      <TableCell>{renderThreatIntelBadges(vuln)}</TableCell>
                      <TableCell>{vuln.affected_devices?.toLocaleString('en-US') ?? 0}</TableCell>
                      <TableCell>{formatDate(vuln.last_seen_timestamp)}</TableCell>
                      <TableCell>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => handleShowDetail(vuln)}
                        >
                          Details
                        </Button>
                      </TableCell>
                    </TableRow>
                  ))
                )}
              </TableBody>
            </Table>
          </div>
          <div className="flex items-center justify-between mt-4">
            <div className="text-sm text-text-secondary">
              Showing {vulnerabilities.length} of {pagination.total} results
            </div>
            <div className="flex gap-2">
              <Button
                variant="outline"
                size="sm"
                onClick={() => handlePageChange(pagination.page - 1)}
                disabled={pagination.page === 1}
              >
                Previous
              </Button>
              {Array.from({ length: Math.min(5, pagination.totalPages) }, (_, i) => {
                let pageNum: number;
                if (pagination.totalPages <= 5) {
                  pageNum = i + 1;
                } else if (pagination.page <= 3) {
                  pageNum = i + 1;
                } else if (pagination.page >= pagination.totalPages - 2) {
                  pageNum = pagination.totalPages - 4 + i;
                } else {
                  pageNum = pagination.page - 2 + i;
                }
                return (
                  <Button
                    key={pageNum}
                    variant={pagination.page === pageNum ? 'default' : 'outline'}
                    size="sm"
                    onClick={() => handlePageChange(pageNum)}
                  >
                    {pageNum}
                  </Button>
                );
              })}
              <Button
                variant="outline"
                size="sm"
                onClick={() => handlePageChange(pagination.page + 1)}
                disabled={pagination.page === pagination.totalPages}
              >
                Next
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>

      <VulnerabilityDetailDialog
        open={showDetailModal}
        onOpenChange={setShowDetailModal}
        vulnerability={selectedVuln}
      />
    </>
  );
};

export default VulnerabilityTable;
