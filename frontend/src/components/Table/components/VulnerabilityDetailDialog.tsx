import { useEffect, useState } from 'react';
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { formatDate } from '@/utils/formatters';
import type { Vulnerability, VulnerabilityDetailEntry } from '@/types/api';
import { renderSeverityBadge } from './severityBadge';
import apiService from '@/services/api';

interface VulnerabilityDetailDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  vulnerability: Vulnerability | null;
}

const VulnerabilityDetailDialog = ({ open, onOpenChange, vulnerability }: VulnerabilityDetailDialogProps) => {
  const [detailInfo, setDetailInfo] = useState<VulnerabilityDetailEntry | null>(null);
  const [isDetailLoading, setIsDetailLoading] = useState(false);

  useEffect(() => {
    let isMounted = true;
    if (!open || !vulnerability?.cve_id) {
      setDetailInfo(null);
      return () => {
        isMounted = false;
      };
    }

    setIsDetailLoading(true);
    void apiService.getVulnerabilityCatalogEntry(vulnerability.cve_id)
      .then((data) => {
        if (isMounted) {
          setDetailInfo(data);
        }
      })
      .catch(() => {
        if (isMounted) {
          setDetailInfo(null);
        }
      })
      .finally(() => {
        if (isMounted) {
          setIsDetailLoading(false);
        }
      });

    return () => {
      isMounted = false;
    };
  }, [open, vulnerability?.cve_id]);

  const combinedDescription = vulnerability?.description;
  const epssScore = typeof vulnerability?.cve_epss === 'number'
    ? vulnerability.cve_epss
    : detailInfo?.epss;

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Vulnerability Details</DialogTitle>
          <DialogDescription>
            Complete information about the selected vulnerability
          </DialogDescription>
        </DialogHeader>
        {vulnerability && (
          <div className="space-y-6">
            <div>
              <h3 className="text-lg font-semibold text-text-primary mb-3">Basic Information</h3>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <div className="text-sm font-medium text-text-secondary">CVE ID</div>
                  <div className="text-text-primary font-mono">{vulnerability.cve_id || '-'}</div>
                </div>
                <div>
                  <div className="text-sm font-medium text-text-secondary">Severity</div>
                  <div>{renderSeverityBadge(vulnerability.severity || vulnerability.vulnerability_severity_level)}</div>
                </div>
                <div>
                  <div className="text-sm font-medium text-text-secondary">CVSS Score</div>
                  <div className="text-text-primary">
                    {vulnerability.cvss_score ? vulnerability.cvss_score.toFixed(1) : '-'}
                  </div>
                </div>
                <div>
                  <div className="text-sm font-medium text-text-secondary">EPSS Score</div>
                  <div className="text-text-primary">
                    {typeof epssScore === 'number' ? epssScore.toFixed(3) : '-'}
                  </div>
                </div>
                <div>
                  <div className="text-sm font-medium text-text-secondary">Status</div>
                  <div className="text-text-primary">{vulnerability.status || '-'}</div>
                </div>
                <div>
                  <div className="text-sm font-medium text-text-secondary">Exploitability Level</div>
                  <div className="text-text-primary">{vulnerability.exploitability_level || '-'}</div>
                </div>
                <div>
                  <div className="text-sm font-medium text-text-secondary">Autopatch Covered</div>
                  <div className="text-text-primary">
                    {vulnerability.autopatch_covered !== undefined
                      ? (vulnerability.autopatch_covered ? 'Yes' : 'No')
                      : '-'}
                  </div>
                </div>
                <div>
                  <div className="text-sm font-medium text-text-secondary">Metasploit</div>
                  <div className="text-text-primary">
                    {vulnerability.metasploit_detected ? 'Detected' : 'Not Detected'}
                  </div>
                </div>
                <div>
                  <div className="text-sm font-medium text-text-secondary">Nuclei</div>
                  <div className="text-text-primary">
                    {vulnerability.nuclei_detected ? 'Detected' : 'Not Detected'}
                  </div>
                </div>
                <div>
                  <div className="text-sm font-medium text-text-secondary">RecordFuture</div>
                  <div className="text-text-primary">
                    {vulnerability.recordfuture_detected ? 'Detected' : 'Not Detected'}
                  </div>
                </div>
              </div>
            </div>

            <div>
              <h3 className="text-lg font-semibold text-text-primary mb-3">Device Information</h3>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <div className="text-sm font-medium text-text-secondary">Device ID</div>
                  <div className="text-text-primary font-mono">{vulnerability.device_id || '-'}</div>
                </div>
                <div>
                  <div className="text-sm font-medium text-text-secondary">Device Name</div>
                  <div className="text-text-primary">{vulnerability.device_name || '-'}</div>
                </div>
                <div>
                  <div className="text-sm font-medium text-text-secondary">RBAC Group Name</div>
                  <div className="text-text-primary">{vulnerability.rbac_group_name || '-'}</div>
                </div>
              </div>
            </div>

            <div>
              <h3 className="text-lg font-semibold text-text-primary mb-3">Operating System</h3>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <div className="text-sm font-medium text-text-secondary">OS Platform</div>
                  <div className="text-text-primary">{vulnerability.os_platform || vulnerability.platform || '-'}</div>
                </div>
                <div>
                  <div className="text-sm font-medium text-text-secondary">OS Version</div>
                  <div className="text-text-primary">{vulnerability.os_version || '-'}</div>
                </div>
                <div>
                  <div className="text-sm font-medium text-text-secondary">OS Architecture</div>
                  <div className="text-text-primary">{vulnerability.os_architecture || '-'}</div>
                </div>
              </div>
            </div>

            <div>
              <h3 className="text-lg font-semibold text-text-primary mb-3">Software Information</h3>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <div className="text-sm font-medium text-text-secondary">Software Vendor</div>
                  <div className="text-text-primary">{vulnerability.software_vendor || '-'}</div>
                </div>
                <div>
                  <div className="text-sm font-medium text-text-secondary">Software Name</div>
                  <div className="text-text-primary">{vulnerability.software_name || '-'}</div>
                </div>
                <div>
                  <div className="text-sm font-medium text-text-secondary">Software Version</div>
                  <div className="text-text-primary">{vulnerability.software_version || '-'}</div>
                </div>
              </div>
            </div>

            <div>
              <h3 className="text-lg font-semibold text-text-primary mb-3">Timestamps</h3>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <div className="text-sm font-medium text-text-secondary">First Seen</div>
                  <div className="text-text-primary">{formatDate(vulnerability.first_seen || vulnerability.first_seen_timestamp)}</div>
                </div>
                <div>
                  <div className="text-sm font-medium text-text-secondary">Last Seen</div>
                  <div className="text-text-primary">{formatDate(vulnerability.last_seen || vulnerability.last_seen_timestamp)}</div>
                </div>
                <div>
                  <div className="text-sm font-medium text-text-secondary">Event Timestamp</div>
                  <div className="text-text-primary">{formatDate(vulnerability.event_timestamp)}</div>
                </div>
                <div>
                  <div className="text-sm font-medium text-text-secondary">Last Synced</div>
                  <div className="text-text-primary">{formatDate(vulnerability.last_synced || vulnerability.last_updated)}</div>
                </div>
              </div>
            </div>

            <div>
              <h3 className="text-lg font-semibold text-text-primary mb-3">Security Update</h3>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <div className="text-sm font-medium text-text-secondary">Security Update Available</div>
                  <div className="text-text-primary">
                    {vulnerability.security_update_available !== undefined
                      ? (vulnerability.security_update_available ? 'Yes' : 'No')
                      : '-'}
                  </div>
                </div>
                <div>
                  <div className="text-sm font-medium text-text-secondary">Recommended Security Update ID</div>
                  <div className="text-text-primary font-mono">{vulnerability.recommended_security_update_id || '-'}</div>
                </div>
                <div className="col-span-2">
                  <div className="text-sm font-medium text-text-secondary">Recommended Security Update</div>
                  <div className="text-text-primary">{vulnerability.recommended_security_update || '-'}</div>
                </div>
                <div className="col-span-2">
                  <div className="text-sm font-medium text-text-secondary">Recommended Security Update URL</div>
                  {vulnerability.recommended_security_update_url ? (
                    <a
                      href={vulnerability.recommended_security_update_url}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-primary hover:underline break-all"
                    >
                      {vulnerability.recommended_security_update_url}
                    </a>
                  ) : (
                    <div className="text-text-primary">-</div>
                  )}
                </div>
                <div className="col-span-2">
                  <div className="text-sm font-medium text-text-secondary">Recommendation Reference</div>
                  <div className="text-text-primary">{vulnerability.recommendation_reference || '-'}</div>
                </div>
              </div>
            </div>

            {(vulnerability.disk_paths || vulnerability.registry_paths) && (
              <div>
                <h3 className="text-lg font-semibold text-text-primary mb-3">Path Information</h3>
                <div className="space-y-4">
                  {vulnerability.disk_paths && (
                    <div>
                      <div className="text-sm font-medium text-text-secondary mb-2">Disk Paths</div>
                      <div className="bg-glass-bg border border-glass-border rounded p-3 max-h-40 overflow-y-auto">
                        {Array.isArray(vulnerability.disk_paths) ? (
                          <ul className="list-disc list-inside space-y-1">
                            {vulnerability.disk_paths.map((path: string, index: number) => (
                              <li key={index} className="text-text-primary font-mono text-sm">{path}</li>
                            ))}
                          </ul>
                        ) : (
                          <pre className="text-text-primary font-mono text-sm whitespace-pre-wrap">
                            {JSON.stringify(vulnerability.disk_paths, null, 2)}
                          </pre>
                        )}
                      </div>
                    </div>
                  )}
                  {vulnerability.registry_paths && (
                    <div>
                      <div className="text-sm font-medium text-text-secondary mb-2">Registry Paths</div>
                      <div className="bg-glass-bg border border-glass-border rounded p-3 max-h-40 overflow-y-auto">
                        {Array.isArray(vulnerability.registry_paths) ? (
                          <ul className="list-disc list-inside space-y-1">
                            {vulnerability.registry_paths.map((path: string, index: number) => (
                              <li key={index} className="text-text-primary font-mono text-sm">{path}</li>
                            ))}
                          </ul>
                        ) : (
                          <pre className="text-text-primary font-mono text-sm whitespace-pre-wrap">
                            {JSON.stringify(vulnerability.registry_paths, null, 2)}
                          </pre>
                        )}
                      </div>
                    </div>
                  )}
                </div>
              </div>
            )}

            {combinedDescription && (
              <div>
                <h3 className="text-lg font-semibold text-text-primary mb-3">Description</h3>
                <div className="text-text-primary whitespace-pre-line">
                  {combinedDescription}
                </div>
              </div>
            )}

            {detailInfo && (
              <div>
                <h3 className="text-lg font-semibold text-text-primary mb-3">Aggregate Insights</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <div className="text-sm font-medium text-text-secondary">Fleet Severity</div>
                    <div className="text-text-primary">{detailInfo.severity || '-'}</div>
                  </div>
                  <div>
                    <div className="text-sm font-medium text-text-secondary">Fleet CVSS v3</div>
                    <div className="text-text-primary">
                      {typeof detailInfo.cvss_v3 === 'number' ? detailInfo.cvss_v3.toFixed(1) : '-'}
                    </div>
                  </div>
                  <div>
                    <div className="text-sm font-medium text-text-secondary">Affected Devices</div>
                    <div className="text-text-primary">{detailInfo.affected_devices ?? '-'}</div>
                  </div>
                  <div>
                    <div className="text-sm font-medium text-text-secondary">Last Seen (Fleet)</div>
                    <div className="text-text-primary">{detailInfo.last_seen_timestamp ? formatDate(detailInfo.last_seen_timestamp) : '-'}</div>
                  </div>
                </div>
                {isDetailLoading && (
                  <p className="text-xs text-text-secondary mt-2">Loading fleet aggregates...</p>
                )}
              </div>
            )}
          </div>
        )}
      </DialogContent>
    </Dialog>
  );
};

export default VulnerabilityDetailDialog;
